-- Jump Mirror Assist
-- E: Toggle | Range: 10 studs | Cooldown: 0.5s | Safe Team Check

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")

local LP = Players.LocalPlayer
local Character, Humanoid, Root

local function setupChar(char)
    Character = char
    Humanoid = char:WaitForChild("Humanoid")
    Root = char:WaitForChild("HumanoidRootPart")
end

setupChar(LP.Character or LP.CharacterAdded:Wait())
LP.CharacterAdded:Connect(setupChar)

-- SETTINGS
local ENABLED = true
local CHECK_DISTANCE = 10
local COOLDOWN = 0.5

-- State
local lastReact = 0
local lastEnemy
local lastEnemyOnAir = false

-- Phím E bật / tắt
UserInputService.InputBegan:Connect(function(input, gp)
    if gp then return end
    if input.KeyCode == Enum.KeyCode.E then
        ENABLED = not ENABLED
        warn("[Jump Mirror] "..(ENABLED and "ON" or "OFF"))
    end
end)

-- ✅ CHECK TEAM AN TOÀN (không làm script chết)
local function isTeammate(plr)
    if not plr or plr == LP then
        return true
    end

    -- Chỉ check khi CẢ HAI có Team
    if LP.Team ~= nil and plr.Team ~= nil then
        return LP.Team == plr.Team
    end

    -- Không có team → coi là enemy
    return false
end

local function getClosestEnemy()
    local closest, dist = nil, CHECK_DISTANCE

    for _,plr in ipairs(Players:GetPlayers()) do
        if plr ~= LP and not isTeammate(plr) and plr.Character then
            local hrp = plr.Character:FindFirstChild("HumanoidRootPart")
            local hum = plr.Character:FindFirstChild("Humanoid")

            if hrp and hum and hum.Health > 0 then
                local d = (hrp.Position - Root.Position).Magnitude
                if d < dist then
                    dist = d
                    closest = hum
                end
            end
        end
    end

    return closest
end

RunService.Heartbeat:Connect(function()
    if not ENABLED or not Humanoid or Humanoid.Health <= 0 then return end

    local enemyHum = getClosestEnemy()
    if not enemyHum then
        lastEnemy = nil
        return
    end

    -- đổi target → reset state
    if enemyHum ~= lastEnemy then
        lastEnemy = enemyHum
        lastEnemyOnAir = false
        return
    end

    local enemyOnAir = enemyHum.FloorMaterial == Enum.Material.Air

    -- bắt khoảnh khắc enemy rời đất
    if not lastEnemyOnAir and enemyOnAir then
        if tick() - lastReact >= COOLDOWN then
            if Humanoid.FloorMaterial ~= Enum.Material.Air then
                Humanoid:ChangeState(Enum.HumanoidStateType.Jumping)
                lastReact = tick()
            end
        end
    end

    lastEnemyOnAir = enemyOnAir
end)
